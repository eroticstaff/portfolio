{% load static %}
<!doctype html>
<html lang="en">

<head>
    <title>Organizer</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css"
          href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
    <!-- Material Kit CSS -->
    <link href="{% static 'bootstrap/assets/css/material-dashboard.css' %}" rel="stylesheet"/>
    <link href="{% static 'organizer/index.css' %}" rel="stylesheet"/>

    <style>

        ::-webkit-scrollbar {
            width: 10px;
        }

        /* Track */
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        /* Handle */
        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        /* Handle on hover */
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .card-item-body {
            overflow-y: scroll;
            height: 300px;
        }

        .card-item {
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);;
        }

        .card-comp {
            float: left;
        }

        .card-tasks {
            height: 140px;
        }

        .btn-uncompleted {
            background-color: #9fd3b6 !important;
        }

        .card-settings svg {
            float: right;
        }

        .card-settings svg:hover {
            fill: darkseagreen;
        }

        .card-settings-button {
            background-color: Transparent;
            background-repeat: no-repeat;
            border: none;
            cursor: pointer;
            overflow: hidden;
            outline: none;
        }

        .card-delete-button {
            background-color: Transparent;
            background-repeat: no-repeat;
            border: none;
            cursor: pointer;
            overflow: hidden;
            outline: none;
        }

        .card-task-add-button {
            background-color: Transparent;
            background-repeat: no-repeat;
            border: none;
            cursor: pointer;
            overflow: hidden;
            outline: none;
        }
    </style>
</head>

<body>
<div class="wrapper ">
    <div class="sidebar" data-color="purple" data-background-color="white">
        <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | azure | green | orange | danger"

        Tip 2: you can also add an image using data-image tag
    -->
        <div class="logo">
            <a href="#" class="simple-text logo-mini">
                SM
            </a>
            <a href="#" class="simple-text logo-normal">
                Seraph Manager
            </a>
        </div>
        <div class="sidebar-wrapper">
            <ul class="nav">
                <li class="nav-item active  ">
                    <a class="nav-link" href="#0">
                        <i class="material-icons">dashboard</i>
                        <p>Organizer</p>
                    </a>
                </li>
                  <li class="nav-item active  ">
                    <a class="nav-link" href="#0">
                        <i class="material-icons">chat</i>
                        <p>Chat</p>
                    </a>
                </li>
                <!-- your sidebar here -->
            </ul>
        </div>
    </div>
    <div class="main-panel">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-transparent navbar-absolute fixed-top ">
            <div class="container-fluid">
                <div class="navbar-wrapper">
                    <a class="navbar-brand" href="javascript:;">Organizer</a>
                </div>
                <button class="navbar-toggler" type="button" data-toggle="collapse" aria-controls="navigation-index"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="navbar-toggler-icon icon-bar"></span>
                    <span class="navbar-toggler-icon icon-bar"></span>
                    <span class="navbar-toggler-icon icon-bar"></span>
                </button>
                <div class="collapse navbar-collapse justify-content-end">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="javascript:;">
                                <i class="material-icons">notifications</i> Notifications
                            </a>
                        </li>
                        <!-- your navbar here -->
                    </ul>
                </div>
            </div>
        </nav>
        <!-- End Navbar -->
        <div class="content">
            <div class="container-fluid">


                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header card-header-info">
                                <h2 class="card-title">NEW
                                    <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#addModal" style="float: right">Add card
                                    </button>
                                </h2>


                            </div>

                            <div class="modal fade" id="addModal" tabindex="-1" role="dialog"
                                 aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Modal
                                                title</h5>
                                            <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <form>
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1">Name</label>
                                                    <input type="text" class="form-control"
                                                           id="exampleInputEmail1"
                                                           aria-describedby=""
                                                           placeholder="Enter name"
                                                    >

                                                </div>
                                                <div class="form-group">
                                                    <label for="exampleInputEmail1">Description</label>
                                                    <input type="text" class="form-control"
                                                           id="exampleInputEmail1"
                                                           aria-describedby=""
                                                           placeholder="Enter description"
                                                    >

                                                </div>
                                                <div class="card-task-board">
                                                    <input class="tasks-input" hidden name="tasks">
                                                    <h3>Tasks</h3>

                                                </div>


                                                <div class="input-group mb-3">
                                                    <input type="text"
                                                           class="form-control task-name"
                                                           placeholder="Task name"
                                                           aria-label="Task name"
                                                           aria-describedby="button-addon2">
                                                    <button class="card-task-add-button"
                                                            type="button" id="button-addon2">
                                                                            <span class="material-icons">
                                                                                add
                                                                            </span>
                                                    </button>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    Submit
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="card-body">

                                {% for card in new_cards %}
                                    <div class="col-md-3 card-comp">
                                        <div class="card">
                                            <div class="card-header card-header-danger">
                                                <div class="card-settings">
                                                    <button class="card-settings-button" style="float: right"
                                                            data-toggle="modal"
                                                            data-target="#exampleModal{{ card.id }}">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                                             fill="currentColor" class="bi bi-box-arrow-in-up-right"
                                                             viewBox="0 0 16 16">
                                                            <path fill-rule="evenodd"
                                                                  d="M6.364 13.5a.5.5 0 0 0 .5.5H13.5a1.5 1.5 0 0 0 1.5-1.5v-10A1.5 1.5 0 0 0 13.5 1h-10A1.5 1.5 0 0 0 2 2.5v6.636a.5.5 0 1 0 1 0V2.5a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 .5.5v10a.5.5 0 0 1-.5.5H6.864a.5.5 0 0 0-.5.5z"/>
                                                            <path fill-rule="evenodd"
                                                                  d="M11 5.5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793l-8.147 8.146a.5.5 0 0 0 .708.708L10 6.707V10.5a.5.5 0 0 0 1 0v-5z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <h4 class="card-title">{{ card.name }}</h4>

                                                <p class="category">{{ card.description }}</p>

                                            </div>
                                            <div class="card-body card-item-body">
                                                <div class="card-tasks">
                                                    <ul>
                                                        {% for task in card.tasks_set.all %}
                                                            <li><p>{{ task.name }}</p></li>
                                                        {% endfor %}
                                                    </ul>


                                                    <!-- Modal -->
                                                    <div class="modal fade" id="exampleModal{{ card.id }}" tabindex="-1"
                                                         role="dialog"
                                                         aria-labelledby="exampleModalLabel" aria-hidden="true">
                                                        <div class="modal-dialog" role="document">
                                                            <div class="modal-content">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="exampleModalLabel">Edit
                                                                        card</h5>
                                                                    <button type="button" class="close"
                                                                            data-dismiss="modal"
                                                                            aria-label="Close">
                                                                        <span aria-hidden="true">&times;</span>
                                                                    </button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <form method="post"
                                                                          action="{% url 'organizer:save' %}">
                                                                        {% csrf_token %}
                                                                        <div class="form-group">
                                                                            <input hidden name="card-id"
                                                                                   value="{{ card.id }}">
                                                                            <label for="exampleInputEmail1">Name</label>
                                                                            <input type="text" class="form-control"
                                                                                   id="exampleInputEmail1"
                                                                                   aria-describedby=""
                                                                                   placeholder="Enter name"
                                                                                   value="{{ card.name }}"
                                                                                   name="card-name">

                                                                        </div>
                                                                         <div class="form-group">
                                                                            <label for="exampleInputEmail1">Name</label>
                                                                            <input type="text" class="form-control"
                                                                                   id="exampleInputEmail1"
                                                                                   aria-describedby=""
                                                                                   placeholder="Enter description"
                                                                                   value="{{ card.description }}"
                                                                                   name="card-description">

                                                                        </div>
                                                                        <div class="card-task-board">
                                                                            <input class="tasks-input" hidden
                                                                                   name="card-tasks">
                                                                            <h3>Tasks</h3>
                                                                            {% for task in card.tasks_set.all %}
                                                                                <div class="alert alert-info card-task"
                                                                                     role="alert" visible>
                                                                                    {{ task.name }}
                                                                                    <div class="card-delete-button"
                                                                                         style="float: right;">
                                                                                    <span class="material-icons">
                                                                                    clear
                                                                                    </span>
                                                                                    </div>
                                                                                </div>
                                                                            {% endfor %}

                                                                        </div>


                                                                        <div class="input-group mb-3">
                                                                            <input type="text"
                                                                                   class="form-control task-name"
                                                                                   placeholder="Task name"
                                                                                   aria-label="Task name"
                                                                                   aria-describedby="button-addon2">
                                                                            <button class="card-task-add-button"
                                                                                    type="button" id="button-addon2">
                                                                            <span class="material-icons">
                                                                                add
                                                                            </span>
                                                                            </button>
                                                                        </div>
                                                                        <button type="submit" class="btn btn-primary">
                                                                            Save
                                                                        </button>
                                                                    </form>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>


                                                </div>


                                            </div>
                                            <button class="btn btn-primary" style="width: 100%">BEGIN</button>

                                        </div>
                                    </div>
                                {% endfor %}

                            </div>

                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header card-header-warning">
                                <h2 class="card-title">IN PROGRESS</h2>
                            </div>
                            <div class="card-body">
                                {% for card in in_progress_cards %}
                                    <div class="col-md-3 card-comp">
                                        <div class="card">
                                            <div class="card-header card-header-danger">
                                                <h4 class="card-title">{{ card.name }}</h4>
                                                <p class="category">{{ card.description }}</p>
                                            </div>
                                            <div class="card-body card-item-body">

                                                <div class="checklist" data-id="{{ card.id }}">
                                                    {% for task in card.tasks_set.all %}
                                                        <input class="check-task" id="{{ task.id }}" type="checkbox"
                                                               name="r"
                                                               value="1">
                                                        <label for="{{ task.id }}">{{ task.name }}</label>
                                                    {% endfor %}

                                                </div>


                                            </div>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar bg-success bar-1" role="progressbar"
                                                     style="width: 0%" aria-valuenow="25" aria-valuemin="0"
                                                     aria-valuemax="100"></div>
                                            </div>
                                            <button class="btn btn-success btn-id-{{ card.id }}" disabled="disabled"
                                                    style="width: 100%">
                                                COMPLETE
                                            </button>

                                        </div>
                                    </div>
                                {% endfor %}

                            </div>
                        </div>

                    </div>

                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header card-header-success">
                                <h2 class="card-title">COMPLETE</h2>
                            </div>
                            <div class="card-body">


                            </div>
                        </div>

                    </div>

                </div>


                <footer class="footer">
                    <div class="container-fluid">
                        <nav class="float-left">
                            <ul>
                                <li>
                                    <a href="#">
                                        xyamix
                                    </a>
                                </li>
                            </ul>
                        </nav>
                        <div class="copyright float-right">
                            &copy;
                            <script>
                                document.write(new Date().getFullYear())
                            </script>
                            , made with <i class="material-icons">favorite</i> by
                            <a href="https://www.creative-tim.com" target="_blank">xyamix</a> for a portfolio.
                        </div>
                        <!-- your footer here -->
                    </div>
                </footer>
            </div>
        </div>


        <!--   Core JS Files   -->
        <script src="https://code.jquery.com/jquery-3.6.0.js"
                integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
        <script src="{% static 'bootstrap/assets/js/core/popper.min.js' %}" type="text/javascript"></script>
        <script src="{% static 'bootstrap/assets/js/core/bootstrap-material-design.min.js' %}"
                type="text/javascript"></script>


        <script>

            var hidden_tasks = [];
            var new_tasks = []

            function setTasks(parent) {
                var tasks_data = $(parent).children(".alert");
                var tasks = [];
                tasks_data.each(function () {
                    console.log("!!!");
                    console.log($(this));
                    console.log($(this).is(":visible"));
                    if ($(this).is(":visible")) {
                        console.log("I AM IN");
                        console.log($(this).contents().get(0).nodeValue.trim())
                        var task_text = $(this).contents().get(0).nodeValue.trim();
                        tasks.push(task_text);
                    }

                });
                console.log(tasks);
                var tasksJSON = JSON.stringify(tasks);
                console.log(tasksJSON);
                console.log($(parent).children(".tasks-input"));
                $(parent).children(".tasks-input").each(function () {
                    $(this).val(tasksJSON);
                    console.log($(this).val());
                });

            }

            $(document).ready(function () {


                function refreshTasks() {
                    $(".card-delete-button").on("click", function () {
                        var parent = $(this).parent();
                        var mainParent = $(parent).parent();
                        $(parent).hide();
                        if (!$(parent).hasClass("new_task")) {
                            hidden_tasks.push($(parent));
                        }
                        setTasks(mainParent);
                    });
                }

                $(".modal").on('hidden.bs.modal', function () {
                    hidden_tasks.forEach(function (item, i, arr) {
                        item.show();
                    })
                    $(".card-task-board").children(".new_task").each(function () {
                        $(this).remove();
                    });
                });
                $('.modal').on('shown.bs.modal', function (e) {
                    $(".card-task-board").each(function () {
                        setTasks($(this));
                    })
                })
                refreshTasks();
                $(".card-task-add-button").on("click", function () {
                    var parent = $(this).parent();
                    var mainParent = parent.parent();
                    var taskName = parent.children(".task-name").val();
                    if (taskName != "") {
                        mainParent.children(".card-task-board").append("<div class=\"alert alert-info new_task card-task\"\n" +
                            "                                                                             role=\"alert\">\n" +
                            "                                                                            " + taskName + "\n" +
                            "                                                                            <div class=\"card-delete-button\"\n" +
                            "                                                                                 style=\"float: right\">\n" +
                            "                                                                            <span class=\"material-icons\">\n" +
                            "                                                                            clear\n" +
                            "                                                                            </span>\n" +
                            "                                                                            </div>\n" +
                            "                                                                        </div>");
                    }
                    setTasks(mainParent.children(".card-task-board"));
                    parent.children(".task-name").val("");
                    refreshTasks();
                });


                //set initial state.
                $('.check-task').change(function () {
                    var parent = $(this).parent();
                    var n = 0;
                    var completed = 0;
                    $(parent).children("input").each(function () {
                        if ($(this).prop("checked")) {
                            completed += 1;
                        }
                        n += 1;
                    });
                    var proc = completed / n * 100;
                    console.log(proc);
                    id = $(parent).data("id");
                    $(".bar-" + id).css('width', proc + "%");

                    if (proc == 100) {
                        $(".btn-id-" + id).prop('disabled', false);

                    } else {
                        $(".btn-id-" + id).prop('disabled', true);

                    }
                });

            });

        </script>

</body>

</html>